name: Code Review
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: "https://open.bigmodel.cn/api/anthropic"
        run: |
          npx @anthropic-ai/claude-code review --model=opus --agent=code-reviewer > review.md << 'EOF'
          You are a senior code reviewer ensuring high standards of code quality and security.

          Please review the changes in this pull request for:

          1. Code Quality:
             - Code is simple and readable
             - Functions and variables are well-named
             - No duplicated code
             - Proper error handling

          2. Security:
             - No exposed secrets or API keys
             - Input validation implemented
             - Proper authentication/authorization

          3. Maintainability:
             - Good test coverage
             - Performance considerations addressed
             - Documentation is clear

          Please provide your feedback organized by priority:
          - Critical issues (must fix)
          - Warnings (should fix)
          - Suggestions (consider improving)

          Include specific examples of how to fix any issues found.
          EOF

      - name: Comment PR with Review Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const reviewContent = fs.readFileSync('review.md', 'utf8');

              // å¦‚æœå®¡æŸ¥å†…å®¹ä¸ºç©ºæˆ–åªåŒ…å«ç©ºè¡Œï¼Œåˆ™ä¸è¯„è®º
              if (!reviewContent.trim()) {
                console.log('Review content is empty, skipping comment');
                return;
              }

              // æ ¼å¼åŒ–è¯„è®ºå†…å®¹
              const commentBody = "## ğŸ¤– Claude Code Review Results\n\n" +
                                 reviewContent + "\n\n" +
                                 "---\n" +
                                 "*This review was generated by Claude Code using the Opus model.*";

              // åˆ›å»ºæˆ–æ›´æ–°è¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰ Claude Code çš„è¯„è®º
              const existingComment = comments.find(comment =>
                comment.body.includes('ğŸ¤– Claude Code Review Results') &&
                comment.user.type === 'Bot'
              );

              if (existingComment) {
                // æ›´æ–°ç°æœ‰è¯„è®º
                await github.rest.issues.updateComment({
                  comment_id: existingComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: commentBody
                });
                console.log('Updated existing review comment');
              } else {
                // åˆ›å»ºæ–°è¯„è®º
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: commentBody
                });
                console.log('Created new review comment');
              }
            } catch (error) {
              console.error('Error reading review results:', error);
              // å¦‚æœè¯»å–æ–‡ä»¶å¤±è´¥ï¼Œåˆ›å»ºé”™è¯¯è¯„è®º
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '## ğŸ¤– Claude Code Review\n\nâŒ Failed to generate review results. Please check the workflow logs for details.'
              });
            }

  push-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files since last push
          git diff --name-only HEAD~1 HEAD > changed_files.txt
          echo "changed_files=$(cat changed_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Run Code Review on Push
        if: steps.changed-files.outputs.changed_files != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: "https://open.bigmodel.cn/api/anthropic"
        run: |
          npx @anthropic-ai/claude-code review --model=opus --agent=code-reviewer > push-review.md << 'EOF'
          You are a senior code reviewer ensuring high standards of code quality and security.

          Changed files in this push: ${{ steps.changed-files.outputs.changed_files }}

          Please review the recent changes for:

          1. Code Quality:
             - Code is simple and readable
             - Functions and variables are well-named
             - No duplicated code
             - Proper error handling

          2. Security:
             - No exposed secrets or API keys
             - Input validation implemented

          3. Maintainability:
             - Performance considerations addressed

          Focus on the modified files and provide feedback organized by priority.
          EOF

      - name: Comment Commit with Review Results
        if: always() && steps.changed-files.outputs.changed_files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const reviewContent = fs.readFileSync('push-review.md', 'utf8');

              // å¦‚æœå®¡æŸ¥å†…å®¹ä¸ºç©ºæˆ–åªåŒ…å«ç©ºè¡Œï¼Œåˆ™ä¸è¯„è®º
              if (!reviewContent.trim()) {
                console.log('Review content is empty, skipping comment');
                return;
              }

              // è·å–æœ€æ–°çš„ commit SHA
              const commitSha = context.sha.substring(0, 7);

              // æ ¼å¼åŒ–è¯„è®ºå†…å®¹
              const commentBody = "## ğŸ¤– Code Review for Push " + commitSha + "\n\n" +
                                 "Changed files: " + "${{ steps.changed-files.outputs.changed_files }}" + "\n\n" +
                                 reviewContent + "\n\n" +
                                 "---\n" +
                                 "*This review was generated by Claude Code using the Opus model.*";

              // åˆ›å»º commit è¯„è®º
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: commentBody
              });
              console.log('Created commit review comment');
            } catch (error) {
              console.error('Error reading review results:', error);
              // å¦‚æœè¯»å–æ–‡ä»¶å¤±è´¥ï¼Œåˆ›å»ºé”™è¯¯è¯„è®º
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: '## ğŸ¤– Code Review\n\nâŒ Failed to generate review results. Please check the workflow logs for details.'
              });
            }

      - name: Create Issue for Critical Findings
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // å°è¯•è¯»å–å®¡æŸ¥ç»“æœ
            let reviewContent = '';
            let changedFiles = '${{ steps.changed-files.outputs.changed_files }}';

            try {
              reviewContent = fs.readFileSync('push-review.md', 'utf8');
            } catch (error) {
              console.error('Could not read review file:', error);
            }

            // æ„å»º Issue å†…å®¹
            let issueBody = '## ğŸš¨ Code Review - Critical Issues Detected\n\n';
            issueBody += 'The automated code review detected critical issues in the recent push.\n\n';

            // æ·»åŠ å˜æ›´æ–‡ä»¶ä¿¡æ¯
            if (changedFiles) {
              issueBody += '### ğŸ“ Changed Files\n\n';
              issueBody += '```\n' + changedFiles + '\n```\n\n';
            }

            // æ·»åŠ å®¡æŸ¥ç»“æœ
            if (reviewContent.trim()) {
              issueBody += '### ğŸ“‹ Review Details\n\n';
              issueBody += reviewContent + '\n\n';
            }

            // æ·»åŠ æ“ä½œå»ºè®®
            issueBody += '### ğŸ“Œ Next Steps\n\n';
            issueBody += '1. Review the critical issues listed above\n';
            issueBody += '2. Address the identified problems\n';
            issueBody += '3. Push the fixes to resolve this issue\n\n';
            issueBody += '[View Workflow Logs](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ')\n\n';

            // æ·»åŠ è„šæ³¨
            issueBody += '---\n';
            issueBody += '*This issue was automatically created by Claude Code using the Opus model.*';

            // åˆ›å»º Issue
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Code Review - Critical Issues Detected',
              body: issueBody,
              labels: ['code-review', 'critical']
            });