name: Code Review
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write
  issues: write

jobs:
  # PR ä»£ç å®¡æŸ¥ï¼šåªå®¡æŸ¥ PR ä¸­å˜æ›´çš„æ–‡ä»¶
  pr-code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get PR changed files
        id: pr-changed-files
        run: |
          # è·å– PR ä¸­å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          # ä½¿ç”¨ git diff è·å– PR åˆ†æ”¯ä¸ç›®æ ‡åˆ†æ”¯çš„å·®å¼‚
          PR_BASE=${{ github.event.pull_request.base.ref }}
          PR_HEAD=${{ github.event.pull_request.head.ref }}

          # è·å–å˜æ›´çš„æ–‡ä»¶
          git diff --name-only origin/$PR_BASE...origin/$PR_HEAD > pr_changed_files.txt

          # è·å–æ¯ä¸ªæ–‡ä»¶çš„å˜æ›´å†…å®¹
          echo "pr_files=$(cat pr_changed_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT

          # è¾“å‡ºæ–‡ä»¶æ•°é‡
          echo "file_count=$(wc -l < pr_changed_files.txt)" >> $GITHUB_OUTPUT

      - name: Run PR Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: "https://open.bigmodel.cn/api/anthropic"
        run: |
          echo "Reviewing PR #${{ github.event.pull_request.number }}"
          echo "Changed files: ${{ steps.pr-changed-files.outputs.pr_files }}"

          # åˆ›å»ºå®¡æŸ¥ç»“æœæ–‡ä»¶
          > pr_review.md

          # åˆ›å»ºå®¡æŸ¥æç¤ºæ¨¡æ¿æ–‡ä»¶
          cat > review_prompt.txt << 'INNEREOF'
              è¯·å®¡æŸ¥è¿™ä¸ªæ–‡ä»¶çš„å˜æ›´ï¼š

              å˜æ›´å†…å®¹è¯·æŸ¥çœ‹ä¼ å…¥çš„ diff ä¿¡æ¯ã€‚

              è¯·é‡ç‚¹å…³æ³¨ï¼š
              1. ä»£ç è´¨é‡ï¼šå¯è¯»æ€§ã€å‘½åè§„èŒƒã€é‡å¤ä»£ç ã€é”™è¯¯å¤„ç†
              2. å®‰å…¨æ€§ï¼šæ˜¯å¦æœ‰æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒ
              3. ç»´æŠ¤æ€§ï¼šæµ‹è¯•è¦†ç›–ç‡ã€æ€§èƒ½è€ƒè™‘ã€æ–‡æ¡£æ¸…æ™°åº¦

              è¯·æä¾›å…·ä½“çš„ä¿®æ”¹å»ºè®®ï¼Œå¦‚æœå‘ç°é—®é¢˜ï¼Œè¯·æŒ‡å‡ºå…·ä½“çš„è¡Œå·å’Œä¿®å¤æ–¹æ¡ˆã€‚
          INNEREOF

          # å¯¹æ¯ä¸ªå˜æ›´çš„æ–‡ä»¶è¿›è¡Œå®¡æŸ¥
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "" >> pr_review.md
              echo "========================================" >> pr_review.md
              echo "Reviewing file: $file" >> pr_review.md
              echo "========================================" >> pr_review.md
              echo "" >> pr_review.md

              # è·å–æ–‡ä»¶çš„å˜æ›´å·®å¼‚
              git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} -- "$file" > "${file}_diff.txt"

              # ä½¿ç”¨å˜é‡ä¼ é€’å†…å®¹ç»™ Claude Code
              DIFF_CONTENT=$(cat "${file}_diff.txt")

              # æ„å»ºå®Œæ•´çš„å®¡æŸ¥è¯·æ±‚
              REVIEW_REQUEST="æ–‡ä»¶: $file"$'\n\n'"å˜æ›´å†…å®¹:"$'\n'"```diff"$'\n'"$DIFF_CONTENT"$'\n'"```"$'\n\n'$(cat review_prompt.txt)

              # è¿è¡Œ Claude Code å®¡æŸ¥
              echo "$REVIEW_REQUEST" | npx @anthropic-ai/claude-code review --model=opus --agent=code-reviewer >> pr_review.md

              echo "" >> pr_review.md
            fi
          done < pr_changed_files.txt

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f review_prompt.txt

      - name: Create File-level Review Comments
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // è·å– PR ä¿¡æ¯
            const prNumber = context.issue.number;
            const baseSha = context.payload.pull_request.base.sha;
            const headSha = context.payload.pull_request.head.sha;

            // è¯»å–å®¡æŸ¥ç»“æœ
            let reviewContent = '';
            try {
              reviewContent = fs.readFileSync('pr_review.md', 'utf8');
            } catch (error) {
              console.error('Could not read review file:', error);
              return;
            }

            // å¦‚æœæ²¡æœ‰å®¡æŸ¥å†…å®¹ï¼Œåˆ™è¿”å›
            if (!reviewContent.trim()) {
              console.log('No review content found');
              return;
            }

            // åˆ›å»º PR ä¸»ä½“è¯„è®º
            const summaryComment = "## ğŸ¤– PR Code Review Results\n\n" +
                                 reviewContent + "\n\n" +
                                 "---\n" +
                                 "*This review was generated by Claude Code using the Opus model.*";

            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰ Claude Code çš„è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes('ğŸ¤– PR Code Review Results') &&
              comment.user.type === 'Bot'
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summaryComment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summaryComment
              });
            }

  # Push ä»£ç å®¡æŸ¥ï¼šå®¡æŸ¥æ¨é€åˆ° master åˆ†æ”¯çš„å˜æ›´
  push-code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get changed files
        id: changed-files
        run: |
          # è·å–ä¸ä¸Šæ¬¡æäº¤ç›¸æ¯”çš„å˜æ›´æ–‡ä»¶
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt
          else
            # é¦–æ¬¡æ¨é€ï¼Œè·å–æœ€è¿‘çš„æäº¤
            git diff --name-only HEAD~1 HEAD > changed_files.txt
          fi
          echo "changed_files=$(cat changed_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Run Code Review on Push
        if: steps.changed-files.outputs.changed_files != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: "https://open.bigmodel.cn/api/anthropic"
        run: |
          echo "Reviewing push to ${{ github.ref }}"
          echo "Changed files: ${{ steps.changed-files.outputs.changed_files }}"

          # åˆ›å»ºå®¡æŸ¥ç»“æœæ–‡ä»¶
          > push_review.md

          # åˆ›å»ºå®¡æŸ¥æç¤ºæ¨¡æ¿æ–‡ä»¶
          cat > review_prompt.txt << 'INNEREOF'
              è¯·å®¡æŸ¥è¿™ä¸ªæ–‡ä»¶çš„å˜æ›´ï¼š

              å˜æ›´å†…å®¹è¯·æŸ¥çœ‹ä¼ å…¥çš„ diff ä¿¡æ¯ã€‚

              è¯·é‡ç‚¹å…³æ³¨ï¼š
              1. ä»£ç è´¨é‡ï¼šå¯è¯»æ€§ã€å‘½åè§„èŒƒã€é‡å¤ä»£ç ã€é”™è¯¯å¤„ç†
              2. å®‰å…¨æ€§ï¼šæ˜¯å¦æœ‰æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒ
              3. ç»´æŠ¤æ€§ï¼šæµ‹è¯•è¦†ç›–ç‡ã€æ€§èƒ½è€ƒè™‘ã€æ–‡æ¡£æ¸…æ™°åº¦

              è¯·æä¾›å…·ä½“çš„ä¿®æ”¹å»ºè®®ï¼Œå¦‚æœå‘ç°é—®é¢˜ï¼Œè¯·æŒ‡å‡ºå…·ä½“çš„è¡Œå·å’Œä¿®å¤æ–¹æ¡ˆã€‚
          INNEREOF

          # å¯¹æ¯ä¸ªå˜æ›´çš„æ–‡ä»¶è¿›è¡Œå®¡æŸ¥
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "" >> push_review.md
              echo "========================================" >> push_review.md
              echo "Reviewing file: $file" >> push_review.md
              echo "========================================" >> push_review.md
              echo "" >> push_review.md

              # è·å–æ–‡ä»¶çš„å˜æ›´å·®å¼‚
              git diff ${{ github.event.before }} ${{ github.sha }} -- "$file" > "${file}_diff.txt"

              # ä½¿ç”¨å˜é‡ä¼ é€’å†…å®¹ç»™ Claude Code
              DIFF_CONTENT=$(cat "${file}_diff.txt")

              # æ„å»ºå®Œæ•´çš„å®¡æŸ¥è¯·æ±‚
              REVIEW_REQUEST="æ–‡ä»¶: $file"$'\n\n'"å˜æ›´å†…å®¹:"$'\n'"```diff"$'\n'"$DIFF_CONTENT"$'\n'"```"$'\n\n'$(cat review_prompt.txt)

              # è¿è¡Œ Claude Code å®¡æŸ¥
              echo "$REVIEW_REQUEST" | npx @anthropic-ai/claude-code review --model=opus --agent=code-reviewer >> push_review.md

              echo "" >> push_review.md
            fi
          done < changed_files.txt

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f review_prompt.txt

      - name: Comment Commit with Review Results
        if: always() && steps.changed-files.outputs.changed_files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const reviewContent = fs.readFileSync('push_review.md', 'utf8');

              if (!reviewContent.trim()) {
                console.log('Review content is empty, skipping comment');
                return;
              }

              const commitSha = context.sha.substring(0, 7);
              const commentBody = "## ğŸ¤– Code Review for Push " + commitSha + "\n\n" +
                                 reviewContent + "\n\n" +
                                 "---\n" +
                                 "*This review was generated by Claude Code using the Opus model.*";

              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: commentBody
              });
            } catch (error) {
              console.error('Error creating commit comment:', error);
            }

      - name: Create Issue for Critical Findings
        if: failure() && steps.changed-files.outputs.changed_files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reviewContent = '';
            let changedFiles = '${{ steps.changed-files.outputs.changed_files }}';

            try {
              reviewContent = fs.readFileSync('push_review.md', 'utf8');
            } catch (error) {
              console.error('Could not read review file:', error);
            }

            let issueBody = '## ğŸš¨ Code Review - Critical Issues Detected\n\n';
            issueBody += 'The automated code review detected critical issues in the recent push.\n\n';

            if (changedFiles) {
              issueBody += '### ğŸ“ Changed Files\n\n';
              issueBody += '```\n' + changedFiles + '\n```\n\n';
            }

            if (reviewContent.trim()) {
              issueBody += '### ğŸ“‹ Review Details\n\n';
              issueBody += reviewContent + '\n\n';
            }

            issueBody += '### ğŸ“Œ Next Steps\n\n';
            issueBody += '1. Review the critical issues listed above\n';
            issueBody += '2. Address the identified problems\n';
            issueBody += '3. Push the fixes to resolve this issue\n\n';
            issueBody += '[View Workflow Logs](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ')\n\n';

            issueBody += '---\n';
            issueBody += '*This issue was automatically created by Claude Code using the Opus model.*';

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Code Review - Critical Issues Detected',
              body: issueBody,
              labels: ['code-review', 'critical']
            });