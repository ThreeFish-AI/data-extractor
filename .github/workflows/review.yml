name: Code Review
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write
  issues: write

jobs:
  # PR ‰ª£Á†ÅÂÆ°Êü•ÔºöÂè™ÂÆ°Êü• PR ‰∏≠ÂèòÊõ¥ÁöÑÊñá‰ª∂
  pr-code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get PR changed files
        id: pr-changed-files
        run: |
          # Ëé∑Âèñ PR ‰∏≠ÂèòÊõ¥ÁöÑÊñá‰ª∂ÂàóË°®
          # ‰ΩøÁî® git diff Ëé∑Âèñ PR ÂàÜÊîØ‰∏éÁõÆÊ†áÂàÜÊîØÁöÑÂ∑ÆÂºÇ
          PR_BASE=${{ github.event.pull_request.base.ref }}
          PR_HEAD=${{ github.event.pull_request.head.ref }}

          # Ëé∑ÂèñÂèòÊõ¥ÁöÑÊñá‰ª∂
          git diff --name-only origin/$PR_BASE...origin/$PR_HEAD > pr_changed_files.txt

          # Ëé∑ÂèñÊØè‰∏™Êñá‰ª∂ÁöÑÂèòÊõ¥ÂÜÖÂÆπ
          echo "pr_files=$(cat pr_changed_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT

          # ËæìÂá∫Êñá‰ª∂Êï∞Èáè
          echo "file_count=$(wc -l < pr_changed_files.txt)" >> $GITHUB_OUTPUT

      - name: Run PR Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: "https://open.bigmodel.cn/api/anthropic"
        run: |
          echo "Reviewing PR #${{ github.event.pull_request.number }}"
          echo "Changed files: ${{ steps.pr-changed-files.outputs.pr_files }}"

          # ÂØπÊØè‰∏™ÂèòÊõ¥ÁöÑÊñá‰ª∂ËøõË°åÂÆ°Êü•
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo ""
              echo "========================================"
              echo "Reviewing file: $file"
              echo "========================================"

              # Ëé∑ÂèñÊñá‰ª∂ÁöÑÂèòÊõ¥Â∑ÆÂºÇ
              git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} -- "$file" > "${file}_diff.txt"

              # ËøêË°å Claude Code ÂÆ°Êü•
              npx @anthropic-ai/claude-code review --model=opus --agent=code-reviewer << EOF
              ËØ∑ÂÆ°Êü•Ëøô‰∏™Êñá‰ª∂ $file ÁöÑÂèòÊõ¥Ôºö

              ÂèòÊõ¥ÂÜÖÂÆπÔºö
              \`\`\`diff
              $(cat "${file}_diff.txt")
              \`\`\`

              ËØ∑ÈáçÁÇπÂÖ≥Ê≥®Ôºö
              1. ‰ª£Á†ÅË¥®ÈáèÔºöÂèØËØªÊÄß„ÄÅÂëΩÂêçËßÑËåÉ„ÄÅÈáçÂ§ç‰ª£Á†Å„ÄÅÈîôËØØÂ§ÑÁêÜ
              2. ÂÆâÂÖ®ÊÄßÔºöÊòØÂê¶ÊúâÊïèÊÑü‰ø°ÊÅØÊ≥ÑÈú≤„ÄÅËæìÂÖ•È™åËØÅ„ÄÅËÆ§ËØÅÊéàÊùÉ
              3. Áª¥Êä§ÊÄßÔºöÊµãËØïË¶ÜÁõñÁéá„ÄÅÊÄßËÉΩËÄÉËôë„ÄÅÊñáÊ°£Ê∏ÖÊô∞Â∫¶

              ËØ∑Êèê‰æõÂÖ∑‰ΩìÁöÑ‰øÆÊîπÂª∫ËÆÆÔºåÂ¶ÇÊûúÂèëÁé∞ÈóÆÈ¢òÔºåËØ∑ÊåáÂá∫ÂÖ∑‰ΩìÁöÑË°åÂè∑Âíå‰øÆÂ§çÊñπÊ°à„ÄÇ
              EOF

              echo ""
            fi
          done < pr_changed_files.txt > pr_review.md

      - name: Create File-level Review Comments
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // Ëé∑Âèñ PR ‰ø°ÊÅØ
            const prNumber = context.issue.number;
            const baseSha = context.payload.pull_request.base.sha;
            const headSha = context.payload.pull_request.head.sha;

            // ËØªÂèñÂÆ°Êü•ÁªìÊûú
            let reviewContent = '';
            try {
              reviewContent = fs.readFileSync('pr_review.md', 'utf8');
            } catch (error) {
              console.error('Could not read review file:', error);
              return;
            }

            // Â¶ÇÊûúÊ≤°ÊúâÂÆ°Êü•ÂÜÖÂÆπÔºåÂàôËøîÂõû
            if (!reviewContent.trim()) {
              console.log('No review content found');
              return;
            }

            // ÂàõÂª∫ PR ‰∏ª‰ΩìËØÑËÆ∫
            const summaryComment = "## ü§ñ PR Code Review Results\n\n" +
                                 reviewContent + "\n\n" +
                                 "---\n" +
                                 "*This review was generated by Claude Code using the Opus model.*";

            // Êü•ÊâæÊòØÂê¶Â∑≤Êúâ Claude Code ÁöÑËØÑËÆ∫
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes('ü§ñ PR Code Review Results') &&
              comment.user.type === 'Bot'
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summaryComment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summaryComment
              });
            }

  # Push ‰ª£Á†ÅÂÆ°Êü•ÔºöÂÆ°Êü•Êé®ÈÄÅÂà∞ master ÂàÜÊîØÁöÑÂèòÊõ¥
  push-code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get changed files
        id: changed-files
        run: |
          # Ëé∑Âèñ‰∏é‰∏äÊ¨°Êèê‰∫§Áõ∏ÊØîÁöÑÂèòÊõ¥Êñá‰ª∂
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt
          else
            # È¶ñÊ¨°Êé®ÈÄÅÔºåËé∑ÂèñÊúÄËøëÁöÑÊèê‰∫§
            git diff --name-only HEAD~1 HEAD > changed_files.txt
          fi
          echo "changed_files=$(cat changed_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Run Code Review on Push
        if: steps.changed-files.outputs.changed_files != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: "https://open.bigmodel.cn/api/anthropic"
        run: |
          echo "Reviewing push to ${{ github.ref }}"
          echo "Changed files: ${{ steps.changed-files.outputs.changed_files }}"

          # ÂØπÊØè‰∏™ÂèòÊõ¥ÁöÑÊñá‰ª∂ËøõË°åÂÆ°Êü•
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo ""
              echo "========================================"
              echo "Reviewing file: $file"
              echo "========================================"

              # Ëé∑ÂèñÊñá‰ª∂ÁöÑÂèòÊõ¥Â∑ÆÂºÇ
              git diff ${{ github.event.before }} ${{ github.sha }} -- "$file" > "${file}_diff.txt"

              # ËøêË°å Claude Code ÂÆ°Êü•
              npx @anthropic-ai/claude-code review --model=opus --agent=code-reviewer << EOF
              ËØ∑ÂÆ°Êü•Ëøô‰∏™Êñá‰ª∂ $file ÁöÑÂèòÊõ¥Ôºö

              ÂèòÊõ¥ÂÜÖÂÆπÔºö
              \`\`\`diff
              $(cat "${file}_diff.txt")
              \`\`\`

              ËØ∑ÈáçÁÇπÂÖ≥Ê≥®Ôºö
              1. ‰ª£Á†ÅË¥®ÈáèÔºöÂèØËØªÊÄß„ÄÅÂëΩÂêçËßÑËåÉ„ÄÅÈáçÂ§ç‰ª£Á†Å„ÄÅÈîôËØØÂ§ÑÁêÜ
              2. ÂÆâÂÖ®ÊÄßÔºöÊòØÂê¶ÊúâÊïèÊÑü‰ø°ÊÅØÊ≥ÑÈú≤„ÄÅËæìÂÖ•È™åËØÅ„ÄÅËÆ§ËØÅÊéàÊùÉ
              3. Áª¥Êä§ÊÄßÔºöÊµãËØïË¶ÜÁõñÁéá„ÄÅÊÄßËÉΩËÄÉËôë„ÄÅÊñáÊ°£Ê∏ÖÊô∞Â∫¶

              ËØ∑Êèê‰æõÂÖ∑‰ΩìÁöÑ‰øÆÊîπÂª∫ËÆÆÔºåÂ¶ÇÊûúÂèëÁé∞ÈóÆÈ¢òÔºåËØ∑ÊåáÂá∫ÂÖ∑‰ΩìÁöÑË°åÂè∑Âíå‰øÆÂ§çÊñπÊ°à„ÄÇ
              EOF

              echo ""
            fi
          done < changed_files.txt > push_review.md

      - name: Comment Commit with Review Results
        if: always() && steps.changed-files.outputs.changed_files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const reviewContent = fs.readFileSync('push_review.md', 'utf8');

              if (!reviewContent.trim()) {
                console.log('Review content is empty, skipping comment');
                return;
              }

              const commitSha = context.sha.substring(0, 7);
              const commentBody = "## ü§ñ Code Review for Push " + commitSha + "\n\n" +
                                 reviewContent + "\n\n" +
                                 "---\n" +
                                 "*This review was generated by Claude Code using the Opus model.*";

              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: commentBody
              });
            } catch (error) {
              console.error('Error creating commit comment:', error);
            }

      - name: Create Issue for Critical Findings
        if: failure() && steps.changed-files.outputs.changed_files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reviewContent = '';
            let changedFiles = '${{ steps.changed-files.outputs.changed_files }}';

            try {
              reviewContent = fs.readFileSync('push_review.md', 'utf8');
            } catch (error) {
              console.error('Could not read review file:', error);
            }

            let issueBody = '## üö® Code Review - Critical Issues Detected\n\n';
            issueBody += 'The automated code review detected critical issues in the recent push.\n\n';

            if (changedFiles) {
              issueBody += '### üìÅ Changed Files\n\n';
              issueBody += '```\n' + changedFiles + '\n```\n\n';
            }

            if (reviewContent.trim()) {
              issueBody += '### üìã Review Details\n\n';
              issueBody += reviewContent + '\n\n';
            }

            issueBody += '### üìå Next Steps\n\n';
            issueBody += '1. Review the critical issues listed above\n';
            issueBody += '2. Address the identified problems\n';
            issueBody += '3. Push the fixes to resolve this issue\n\n';
            issueBody += '[View Workflow Logs](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ')\n\n';

            issueBody += '---\n';
            issueBody += '*This issue was automatically created by Claude Code using the Opus model.*';

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Code Review - Critical Issues Detected',
              body: issueBody,
              labels: ['code-review', 'critical']
            });